<html>
<head>
<title>SubCover</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js">
</script>
</head>
<body>

<div id="info">
</div>

<canvas id="canvas" width=100% height=100%></canvas>
<br>
<canvas id="cover" width=100% height=100%></canvas>
<div id="div_cover"></div>
<br>
<canvas id="pp" width=100% height=100%></canvas>
<div id="div_pp"></div>


<script>
var lastX=-1,lastY=-1,press=0,dSize=1,sizefactor=1;
var ox=0,oy=0,w=0,h=0;
var canvas,context,img;
function subimg()
{

context.clearRect(0,0,canvas.width,canvas.height);
context.drawImage(img, 0,0,canvas.width,canvas.height);
context.stroke();


//pp
//context.fillRect(ox+w*0.019,oy+h*0.503,h*0.493,h*0.493);

context.lineWidth="1";
context.strokeStyle="white";
context.rect(ox+w*0.019,oy+h*0.503,h*0.493,h*0.493);


document.getElementById("pp").width=h*0.493;
document.getElementById("pp").height=h*0.493;
document.getElementById("pp").getContext("2d").drawImage(img,ox+w*0.019,oy+h*0.503,h*0.493,h*0.493,0,0,h*0.493,h*0.493);

// cover
//context.fillRect(0,0,w,h*0.919);

context.rect(ox,oy,w,h*0.919);
context.lineWidth="1";
context.strokeStyle="white";
context.stroke();

document.getElementById("cover").width=w;
document.getElementById("cover").height=h*0.919;


	var sx=ox,sy=oy,sw,sh;
	if(ox<0) sx=0;
	if(oy<0) ny=0;
	
	if(ox<0) sw=w+ox;
	if(oy<0) sh=h*0.919+oy;
	
	if(ox>0) sx=ox;
	if(oy>0) sy=oy;
	if(ox>0) sw=w-ox;
	if(oy>0) sh=h-oy;
	
	if(ox<0) sw=w+ox;
	if(oy<0) sh=h*0.919+oy;
	
//	document.getElementById("cover").getContext("2d").rect(0,0,sx,sy);
//	document.getElementById("cover").getContext("2d").rect(sx+sw,sy+sh,w,h);
//	document.getElementById("cover").getContext("2d").stroke();
	
	document.getElementById("cover").getContext("2d").drawImage(img,sx,sy,
																sw,sh,
																0,h-sh,sw,sh);

}
function draw()
{
	
	subimg();
}
function showSizeFactor()
{
		w=canvas.width*sizefactor;
		h=canvas.height*sizefactor;
		draw();
		document.getElementById("info").innerHTML="<a href='javascript:dSize/=2;sizefactor-=dSize;showSizeFactor();'>-<"+"/a> "+ sizefactor +" <a href='javascript:dSize*=2;sizefactor+=dSize;showSizeFactor();'>+<"+"/a>";
}

function dataURItoBlob(dataURI,mime) {
    // convert base64 to raw binary data held in a string
    // doesn't handle URLEncoded DataURIs

    var byteString = window.atob(dataURI);

    // separate out the mime component


    // write the bytes of the string to an ArrayBuffer
    //var ab = new ArrayBuffer(byteString.length);
    var ia = new Uint8Array(byteString.length);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }

    // write the ArrayBuffer to a blob, and you're done
    var blob = new Blob([ia], { type: mime });

    return blob;
}
function submitPP()
{
	try{
		var data=document.getElementById("pp").toDataURL();
		var mimeType="image"+data.substring(data.indexOf("/"),data.indexOf("/")+3);
		data=data.substring(data.indexOf(",")+1,data.length);
        blob = dataURItoBlob(data,mimeType);
}catch(e){console.log("Blob"+e);}
var fd = new FormData();
fd.append("access_token",access_token);
fd.append("source", blob);fd.append("message","test");
try{
   $.ajax({
        url:"https://graph.facebook.com/me/photos?access_token=" + access_token,
        type:"POST",
        data:fd,
        processData:false,
        contentType:false,
        cache:false,
        success:function(data)
        {
        		var pid=data["id"];
        		document.getElementById("div_pp").innerHTML='<a href=\'javascript:window.open("https://www.facebook.com/photo.php?fbid="+pid+"&makeprofile=1","_blank");\'>Set as Profile Picture'+'<'+'/a>';        		
        },
        error:function(shr,status,data){
            console.log("error " + data + " Status " + shr.status);
        },
        complete:function(){
            console.log("Ajax Complete");
        }
    });

}catch(e){console.log("ajaxexception:"+e);}

}

function submitCover()
{
	try{
		var data=document.getElementById("pp").toDataURL();
		var mimeType="image"+data.substring(data.indexOf("/"),data.indexOf("/")+3);
		data=data.substring(data.indexOf(",")+1,data.length);
        blob = dataURItoBlob(data,mimeType);
}catch(e){console.log("Blob"+e);}
var fd = new FormData();
fd.append("access_token",access_token);
fd.append("source", blob);fd.append("message","test");
try{
   $.ajax({
        url:"https://graph.facebook.com/me/photos?access_token=" + access_token,
        type:"POST",
        data:fd,
        processData:false,
        contentType:false,
        cache:false,
        success:function(data)
        {
        		var pid=data["id"];
        		document.getElementById("div_cover").innerHTML='<a href=\'javascript:window.open("https://www.facebook.com/photo.php?fbid="+pid+"&makeprofile=1","_blank");\'>Set as Profile Picture'+'<'+'/a>';        		
        },
        error:function(shr,status,data){
            console.log("error " + data + " Status " + shr.status);
        },
        complete:function(){
            console.log("Ajax Complete");
        }
    });

}catch(e){console.log("ajaxexception:"+e);}



}


var access_token="";
document.getElementById("info").innerHTML="Requesting your profile cover url...";

if(access_token.length==0)
{
   top.location.href=location.protocol+"//www.facebook.com/dialog/oauth?client_id=1383863391860833&redirect_uri=http://yogash1290.appspot.com/subcover/oauth/facebook/&scope=user_photos,publish_stream";
}
else
{
	var req=new XMLHttpRequest();
	req.open('GET', "https://graph.facebook.com/me?fields=cover,picture.type(large)&access_token="+access_token, true);

	req.onload= function(e)
	{


		canvas = document.getElementById("canvas");	
		context = canvas.getContext("2d");
		
		img=new Image();
		img.onload=function(){
			canvas.width=w=img.width;
			canvas.height=h=img.height;
			context.drawImage(img, 0,0);
			//subimg();
			document.getElementById("div_pp").innerHTML="<a href='javascript:submitPP();'>post profile picture"+"<"+"/a>";
			document.getElementById("div_cover").innerHTML="<a href='javascript:submitCover();'>post profile cover"+"<"+"/a>";
			
			showSizeFactor();
		};

		document.getElementById("info").innerHTML="Loading your profile cover image...";
		img.src= "http://yogash1290.appspot.com/subcover/direct?url="+JSON.parse( this.response )["cover"]["source"];



		canvas.onmousedown=function(e){
			lastX=-1;
			press=1;
		};
		canvas.onmouseup=function(e){
			press=0;
			lastX=-1;
		};
		canvas.onmousemove=function(e){
			if(!press) return;
			if(lastX==-1){lastX=e.clientX;lastY=e.clientY;}
			ox+=(e.clientX-lastX);
			oy+=(e.clientY-lastY);
			lastX=e.clientX;
			lastY=e.clientY;

			draw();
		};

	};
   req.send();
}

</script>

</body>
</html>